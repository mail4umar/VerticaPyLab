#!/bin/bash

# defaults
: ${VERTICA_PORT:=5433}
: ${SSHD_PORT:=5432}
: ${CONTAINER_NAME:=vertica-demo}
: ${DOCKER_IMAGE:=vertica/vertica-k8s:latest} # see https://hub.docker.com/r/vertica/vertica-k8s

# find where the original script is located
SCRIPT=$(readlink -f ${BASH_SOURCE[0]} 2>/dev/null) ||
  SCRIPT=$(perl -MCwd -le 'print Cwd::abs_path shift' ${BASH_SOURCE[0]}) || # readlink -f not supported (i.e., OSX)
    SCRIPT=${BASH_SOURCE[0]} # only works if full path is specified
DOCKER_CONFIG=${SCRIPT%/*/*}/docker/docker-compose.yml  # take out /bin/<script>

# The OSx version of bash calls the M1 chip "arm64", but if someone updates
# /bin/bash, then it will could use "aarch64" in $MACHTYPE
if [[ $MACHTYPE =~ ^aarch64 ]] || [[ $MACHTYPE =~ ^arm64 ]] ; then
  # Arm based macs crash on a memory check unless this is added
  VERTICA_ENV+=(-e VERTICA_MEMDEBUG=2)
fi

docker container rm $CONTAINER_NAME # clear out old container in case it had issues
docker run -d -p $VERTICA_PORT:5433 -p $SSHD_PORT:5432 --name $CONTAINER_NAME "$@" $DOCKER_IMAGE || exit $?
docker exec ${VERTICA_ENV[@]} $CONTAINER_NAME opt/vertica/bin/admintools -t create_db --database=docker --password= --hosts=localhost || exit $?
