#!/bin/bash

# defaults that can be overridden with environment variables.
: ${FROM_HOME:=false}

# defaults
CONTAINER_NAME=verticalab
DEMO_IMG=verticapy-jupyterlab
PORT=8889

function usage {
    echo "usage: $0 [-h] [-c <container>][-i <image>] [-p <port>]"
    echo
    echo "Options:"
    echo "  -i <image> The name of the image to use for the demo"
    echo "  -c <container> The name you want the container to have to use (Default: verticapy-demo)"
    echo "  -p <port>  Port to use to run jupyterlab (Default: 8889)"
    echo
    exit 1
}

while getopts "p:c:i:h" opt; do
    case ${opt} in
        h)
            usage
            ;;
        i)
            DEMO_IMG=$OPTARG
            ;;
        p)
            PORT=$OPTARG
            ;;
        c)
            CONTAINER_NAME=$OPTARG
            ;;
        \?)
            echo "Unknown option: -${opt}"
            usage
            ;;
    esac
done

if [[ $FROM_HOME = true ]] ; then
    VOL_FLAG="-v $HOME:/project"
fi

# make sure vertica-demo is running
if ! docker exec -i vertica-demo true; then
  echo "Cannot access vertica-demo.  Did you run vertica-install?" >&2
  exit 1
fi

docker run -d -it --rm -p $PORT:8888 $VOL_FLAG --name $CONTAINER_NAME $DEMO_IMG || exit $?

# copy dbadmin@vertica-demo credentials to root@verticapy-demo to enable ssh
docker exec -i vertica-demo bash -c "cd; tar -zcf - .ssh" | docker exec -i $CONTAINER_NAME bash -c "cd; tar -zxf -"

# sleep some time to wait for jupyterlab logs
timeout=10 #seconds
while ! docker logs -n 5 $CONTAINER_NAME | grep -Eo 'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+?.*' >/dev/null && ((timeout--)); do
  sleep 1
  echo "Starting..."
done

echo
echo "copy and paste one of these URLs: "
docker logs -n 5 $CONTAINER_NAME | grep -Eo 'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+?.*' | sed "s/:8888/:${PORT}/" || exit $?

